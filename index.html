<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Forgotten Town</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body{
  margin:0;
  padding:0;
  background:#222;
  overflow:hidden;
  touch-action:none;
}
canvas{display:block;}

.controls{
  position:fixed;
  bottom:16px;
  left:0;
  right:0;
  text-align:center;
  z-index:10;
}
.controls button{
  width:64px;
  height:64px;
  font-size:26px;
  margin:4px;
  border-radius:10px;
  border:none;
  background:#8a5ccf;
  color:white;
}
</style>
</head>
<body>

<canvas id="game"></canvas>

<div class="controls">
  <button ontouchstart="press('up')" ontouchend="release('up')">⬆️</button><br>
  <button ontouchstart="press('left')" ontouchend="release('left')">⬅️</button>
  <button ontouchstart="press('right')" ontouchend="release('right')">➡️</button><br>
  <button ontouchstart="press('down')" ontouchend="release('down')">⬇️</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* CONFIG */
const SIZE = 128;
const SPEED = 4;
const WALK_DELAY = 4;
const WORLD_W = 3000;
const WORLD_H = 3000;

/* ZOOM */
let zoom = 1;
const MIN_ZOOM = 0.5;
const MAX_ZOOM = 2;

canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  zoom += e.deltaY * -0.001;
  zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom));
});

let lastDist = null;
canvas.addEventListener("touchmove", e=>{
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(lastDist){
      zoom += (dist-lastDist)*0.002;
      zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom));
    }
    lastDist=dist;
  }
});
canvas.addEventListener("touchend", ()=> lastDist=null);

/* CONTROLES */
const keys={up:false,down:false,left:false,right:false};
function press(k){keys[k]=true;}
function release(k){keys[k]=false;}

/* JUGADORES */
let players={};

function createPlayer(id,name,x,y,isAI=false){
  players[id]={
    id,name,x,y,
    frame:0,tick:0,
    facing:"right",
    moving:false,
    isAI,
    dirTimer:0,
    dirX:0,
    dirY:0,
    prevX:x,
    prevY:y
  };
}

createPlayer("me","TÚ",500,500);
createPlayer("bot1","Nova",800,600,true);
createPlayer("bot2","Pixel",600,400,true);

/* CÁMARA */
let camera={x:0,y:0};

/* IMÁGENES */
let imagesToLoad=0, imagesLoaded=0;
function onImageLoad(){
  imagesLoaded++;
  if(imagesLoaded===imagesToLoad){
    requestAnimationFrame(update);
  }
}

const walkFrames=[];
for(let i=0;i<=15;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/caminar/caminar_${i}.png`;
  walkFrames.push(img);
}

const idleFrames=[];
for(let i=0;i<=3;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/idle/idle_${i}.png`;
  idleFrames.push(img);
}

/* UPDATE */
function update(){

  const me = players["me"];
  me.moving=false;

  /* CONTROL JUGADOR */
  if(keys.up){me.y-=SPEED;me.moving=true;}
  if(keys.down){me.y+=SPEED;me.moving=true;}
  if(keys.left){me.x-=SPEED;me.facing="left";me.moving=true;}
  if(keys.right){me.x+=SPEED;me.facing="right";me.moving=true;}

  me.x=Math.max(0,Math.min(WORLD_W-SIZE,me.x));
  me.y=Math.max(0,Math.min(WORLD_H-SIZE,me.y));

  /* IA */
  for(let id in players){
    let p=players[id];
    if(!p.isAI) continue;

    p.dirTimer--;
    if(p.dirTimer<=0){
      p.dirTimer=Math.random()*120+60;
      p.dirX=Math.floor(Math.random()*3)-1;
      p.dirY=Math.floor(Math.random()*3)-1;
    }

    p.x += p.dirX*2;
    p.y += p.dirY*2;

    if(p.dirX<0)p.facing="left";
    if(p.dirX>0)p.facing="right";

    p.x=Math.max(0,Math.min(WORLD_W-SIZE,p.x));
    p.y=Math.max(0,Math.min(WORLD_H-SIZE,p.y));
  }

  /* ANIMACIÓN REAL */
  for(let id in players){
    let p=players[id];

    const moved = (p.x!==p.prevX || p.y!==p.prevY);
    p.moving = moved;

    if(moved){
      p.tick++;
      if(p.tick>=WALK_DELAY){
        p.frame=(p.frame+1)%walkFrames.length;
        p.tick=0;
      }
    }else{
      p.frame=0; // vuelve a idle correctamente
    }

    p.prevX=p.x;
    p.prevY=p.y;
  }

  /* CÁMARA */
  camera.x = me.x - canvas.width/(2*zoom) + SIZE/2;
  camera.y = me.y - canvas.height/(2*zoom) + SIZE/2;

  draw();
  requestAnimationFrame(update);
}

/* DRAW */
function draw(){

  ctx.setTransform(zoom,0,0,zoom,0,0);
  ctx.clearRect(0,0,canvas.width/zoom,canvas.height/zoom);

  for(let id in players){
    let p=players[id];

    const px = p.x - camera.x;
    const py = p.y - camera.y;

    let img = p.moving ? walkFrames[p.frame] : idleFrames[0];

    ctx.save();
    if(p.facing==="left"){
      ctx.translate(px+SIZE,py);
      ctx.scale(-1,1);
      ctx.drawImage(img,0,0,SIZE,SIZE);
    }else{
      ctx.drawImage(img,px,py,SIZE,SIZE);
    }
    ctx.restore();

    ctx.fillStyle="white";
    ctx.font="18px Arial";
    ctx.textAlign="center";
    ctx.fillText(p.name, px+SIZE/2, py-10);
  }

  ctx.setTransform(1,0,0,1,0,0);
}
</script>
</body>
</html>
