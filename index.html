<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Forgotten Town</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html, body {
  margin: 0;
  padding: 0;
  background: #222;
  overflow: hidden;
  touch-action: none;
}
canvas { display:block; }
.controls {
  position: fixed;
  bottom: 16px;
  left: 0;
  right: 0;
  text-align: center;
  z-index: 10;
}
.controls button {
  width: 64px;
  height: 64px;
  font-size: 26px;
  margin: 4px;
  border-radius: 10px;
  border: none;
  background: #8a5ccf;
  color: white;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div class="controls">
  <button ontouchstart="press('up')" ontouchend="release('up')">⬆️</button><br>
  <button ontouchstart="press('left')" ontouchend="release('left')">⬅️</button>
  <button ontouchstart="press('right')" ontouchend="release('right')">➡️</button><br>
  <button ontouchstart="press('down')" ontouchend="release('down')">⬇️</button>
</div>

<script>
/* ===== CANVAS ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ===== CONTROLES ===== */
const keys = { up:false, down:false, left:false, right:false };
function press(k){ keys[k]=true; }
function release(k){ keys[k]=false; }
document.addEventListener("keydown", e=>{
  if(e.key==="ArrowUp")press("up");
  if(e.key==="ArrowDown")press("down");
  if(e.key==="ArrowLeft")press("left");
  if(e.key==="ArrowRight")press("right");
});
document.addEventListener("keyup", e=>{
  if(e.key==="ArrowUp")release("up");
  if(e.key==="ArrowDown")release("down");
  if(e.key==="ArrowLeft")release("left");
  if(e.key==="ArrowRight")release("right");
});

/* ===== CONFIG ===== */
const SIZE = 128;
const SPEED = 4;
const WALK_DELAY = 3;
const BLINK_INTERVAL = 5000;
const BLINK_DELAY = 2;

/* ===== CÁMARA + ZOOM ===== */
let camera = { x: 0, y: 0 };
let zoom = 1;
const MIN_ZOOM = 0.5;
const MAX_ZOOM = 2;

/* ===== JUGADOR ===== */
let pony = {
  x: 500, y: 500,
  frame: 0, tick: 0,
  facing: "right",
  moving: false,
  blinking:false,
  blinkIndex:0,
  blinkTimer:Date.now()
};

/* ===== GLITCH ===== */
let glitch = {
  x: 650,
  y: 500,
  lookIndex: 0,
  lookTimer: Date.now(),
  nextLookDelay: 2000 + Math.random()*2000,
  watching: false,
  watchStart: 0
};

/* ===== ZOOM ===== */
canvas.addEventListener("wheel", e=>{
  e.preventDefault();
  zoom += e.deltaY * -0.001;
  zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom));
});

/* ===== IMÁGENES ===== */
let imagesToLoad=0, imagesLoaded=0;
function onImageLoad(){
  imagesLoaded++;
  if(imagesLoaded===imagesToLoad){
    requestAnimationFrame(update);
  }
}

const walkFrames=[];
for(let i=0;i<=15;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/caminar/caminar_${i}.png`;
  walkFrames.push(img);
}

const idleFrames=[];
for(let i=0;i<=3;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/idle/idle_${i}.png`;
  idleFrames.push(img);
}

const glitchLooks=[];
for(let i=0;i<=8;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/look/look_${i}.png`;
  glitchLooks.push(img);
}

/* ===== MIRAR AL JUGADOR ===== */
function getLookTowardPlayer(){
  const dx = pony.x - glitch.x;
  const dy = pony.y - glitch.y;
  if(Math.abs(dx) > Math.abs(dy)){
    return dx > 0 ? 1 : 2;
  } else {
    return dy > 0 ? 3 : 4;
  }
}

/* ===== UPDATE ===== */
function update(){
  pony.moving=false;
  if(keys.up){pony.y-=SPEED;pony.moving=true;}
  if(keys.down){pony.y+=SPEED;pony.moving=true;}
  if(keys.left){pony.x-=SPEED;pony.facing="left";pony.moving=true;}
  if(keys.right){pony.x+=SPEED;pony.facing="right";pony.moving=true;}

  camera.x = pony.x - canvas.width/(2*zoom) + SIZE/2;
  camera.y = pony.y - canvas.height/(2*zoom) + SIZE/2;

  if(pony.moving){
    pony.tick++;
    if(pony.tick>=WALK_DELAY){
      pony.frame=(pony.frame+1)%walkFrames.length;
      pony.tick=0;
    }
    pony.blinking=false;
    pony.blinkTimer=Date.now();
  } else {
    if(!pony.blinking && Date.now()-pony.blinkTimer>BLINK_INTERVAL){
      pony.blinking=true; pony.blinkIndex=0; pony.tick=0;
    }
    if(pony.blinking){
      pony.tick++;
      if(pony.tick>=BLINK_DELAY){
        pony.tick=0; pony.blinkIndex++;
        if(pony.blinkIndex>=6){
          pony.blinking=false; pony.blinkTimer=Date.now();
        }
      }
    }
    pony.frame=0;
  }

  const dx = pony.x - glitch.x;
  const dy = pony.y - glitch.y;
  const dist = Math.hypot(dx, dy);

  if(!glitch.watching && dist < 180 && Math.random() < 0.02){
    glitch.watching = true;
    glitch.watchStart = Date.now();
  }

  if(glitch.watching){
    glitch.lookIndex = getLookTowardPlayer();
    if(Date.now()-glitch.watchStart > 2500){
      glitch.watching=false;
      glitch.lookTimer=Date.now();
      glitch.nextLookDelay=2000+Math.random()*3000;
    }
  } else if(Date.now()-glitch.lookTimer > glitch.nextLookDelay){
    glitch.lookIndex = Math.floor(Math.random()*glitchLooks.length);
    glitch.lookTimer = Date.now();
    glitch.nextLookDelay = 2000 + Math.random()*2000;
  }

  draw();
  requestAnimationFrame(update);
}

/* ===== DRAW ===== */
function draw(){
  ctx.setTransform(zoom,0,0,zoom,0,0);
  ctx.clearRect(0,0,canvas.width/zoom,canvas.height/zoom);

  const px = pony.x - camera.x;
  const py = pony.y - camera.y;
  const gx = glitch.x - camera.x;
  const gy = glitch.y - camera.y;

  ctx.drawImage(glitchLooks[glitch.lookIndex], gx, gy, SIZE, SIZE);

  let img;
  if(pony.moving) img = walkFrames[pony.frame];
  else if(pony.blinking){
    const seq=[0,1,2,3,2,1];
    img = idleFrames[seq[pony.blinkIndex]];
  } else img = idleFrames[0];

  ctx.save();
  if(pony.facing==="left"){
    ctx.translate(px+SIZE,py);
    ctx.scale(-1,1);
    ctx.drawImage(img,0,0,SIZE,SIZE);
  } else ctx.drawImage(img,px,py,SIZE,SIZE);
  ctx.restore();

  ctx.setTransform(1,0,0,1,0,0);
}
</script>
</body>
</html>
