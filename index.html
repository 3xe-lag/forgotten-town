<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Forgotten Town</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html,body{
  margin:0;
  padding:0;
  background:#222;
  overflow:hidden;
  touch-action:none;
}
canvas{display:block;}

#ui{
  position:fixed;
  top:10px;
  left:10px;
  color:white;
  font-size:18px;
  z-index:50;
}

#actionBtn{
  position:fixed;
  bottom:140px;
  right:20px;
  padding:12px 18px;
  font-size:18px;
  display:none;
  z-index:30;
}

/* JOYSTICK */
#joystick{
  position:fixed;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,0.08);
  display:none;
  z-index:20;
}
#stick{
  position:absolute;
  width:60px;
  height:60px;
  border-radius:50%;
  background:rgba(255,255,255,0.3);
  left:30px;
  top:30px;
}
</style>
</head>
<body>

<div id="ui">
Inventario:<br>
ü™µ Madera: <span id="woodCount">0</span><br>
ü™ì Hacha: <span id="axeState">No</span>
</div>

<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>
<button id="actionBtn">Acci√≥n</button>

<script>

/* ===== CANVAS ===== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
window.addEventListener("resize",resize);
resize();

/* ===== CONFIG ===== */
const SIZE=128;
const SPEED=4;
const WALK_DELAY=4;
const WORLD_W=3000;
const WORLD_H=3000;

/* ===== ZOOM ===== */
let zoom=1;
const MIN_ZOOM=0.5;
const MAX_ZOOM=2;

canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  zoom+=e.deltaY*-0.001;
  zoom=Math.max(MIN_ZOOM,Math.min(MAX_ZOOM,zoom));
});

/* ===== C√ÅMARA ===== */
let camera={x:0,y:0};

/* ===== INVENTARIO ===== */
let inventory={wood:0,axe:false};
const woodUI=document.getElementById("woodCount");
const axeUI=document.getElementById("axeState");

/* ===== EVENTO EVA ===== */
let eventPhase=0; 
// 0 normal
// 1 texto rojo 5s
// 2 rodeo 6s

let eventTimer=0;
let killedNPC=null;

/* ===== JUGADOR ===== */
let pony={
  x:WORLD_W/2,
  y:WORLD_H/2,
  frame:0,
  tick:0,
  moving:false,
  facing:"right",
  frozen:false
};

/* ===== NPC ===== */
function createNPC(x,y){
  return{
    x,y,
    originalX:x,
    originalY:y,
    vx:0,vy:0,
    timer:0,
    frame:0,
    tick:0,
    moving:false,
    facing:"right",
    hp:3,
    dead:false
  };
}

let npcs=[
  createNPC(pony.x+200,pony.y-150),
  createNPC(pony.x-250,pony.y+100),
  createNPC(pony.x+300,pony.y+200),
  createNPC(pony.x-300,pony.y-200),
  createNPC(pony.x+400,pony.y)
];

/* ===== HACHA EN SUELO ===== */
let axeWorld={
  x:pony.x+150,
  y:pony.y+80,
  picked:false
};

/* ===== JOYSTICK ===== */
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyActive=false,joyX=0,joyY=0;
let moveX=0,moveY=0;

canvas.addEventListener("touchstart",e=>{
  if(e.touches.length>1)return;
  const t=e.touches[0];
  joyActive=true;
  joystick.style.display="block";
  joystick.style.left=(t.clientX-60)+"px";
  joystick.style.top=(t.clientY-60)+"px";
  joyX=t.clientX; joyY=t.clientY;
});

canvas.addEventListener("touchmove",e=>{
  if(!joyActive||e.touches.length>1)return;
  const t=e.touches[0];
  let dx=t.clientX-joyX;
  let dy=t.clientY-joyY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const max=40;
  if(dist>max){
    dx=dx/dist*max;
    dy=dy/dist*max;
  }
  stick.style.left=(dx+30)+"px";
  stick.style.top=(dy+30)+"px";
  moveX=dx/max;
  moveY=dy/max;
});

canvas.addEventListener("touchend",()=>{
  joyActive=false;
  joystick.style.display="none";
  stick.style.left="30px";
  stick.style.top="30px";
  moveX=0; moveY=0;
});

/* ===== ATAQUE NPC ===== */
canvas.addEventListener("click",()=>{
  if(!inventory.axe) return;
  if(eventPhase!==0) return;

  npcs.forEach(n=>{
    if(n.dead) return;

    const dist=Math.hypot(pony.x-n.x,pony.y-n.y);
    if(dist<150){
      n.hp--;
      n.vx=(n.x-pony.x)*0.15;
      n.vy=(n.y-pony.y)*0.15;

      if(n.hp<=0){
        n.dead=true;
        killedNPC=n;
        startEvent();
      }
    }
  });
});

function startEvent(){
  eventPhase=1;
  eventTimer=300; // 5s
  pony.frozen=true;
}

/* ===== UPDATE ===== */
function update(){

  if(!pony.frozen){
    pony.moving=false;
    if(moveX||moveY){
      pony.x+=moveX*SPEED;
      pony.y+=moveY*SPEED;
      pony.moving=true;
      if(moveX>0)pony.facing="right";
      if(moveX<0)pony.facing="left";
    }
  }

  pony.x=Math.max(0,Math.min(WORLD_W-SIZE,pony.x));
  pony.y=Math.max(0,Math.min(WORLD_H-SIZE,pony.y));

  camera.x=pony.x-(canvas.width/(2*zoom))+SIZE/2;
  camera.y=pony.y-(canvas.height/(2*zoom))+SIZE/2;

  if(pony.moving){
    pony.tick++;
    if(pony.tick>=WALK_DELAY){
      pony.frame=(pony.frame+1)%16;
      pony.tick=0;
    }
  }else pony.frame=0;

  /* NPC movimiento normal */
  npcs.forEach(n=>{
    if(n.dead) return;

    if(eventPhase===0){
      n.timer--;
      if(n.timer<=0){
        if(Math.random()<0.4){
          n.vx=0;n.vy=0;
        }else{
          const a=Math.random()*Math.PI*2;
          n.vx=Math.cos(a)*1.5;
          n.vy=Math.sin(a)*1.5;
        }
        n.timer=60+Math.random()*120;
      }

      n.x+=n.vx;
      n.y+=n.vy;

      n.moving=Math.abs(n.vx)>0.1||Math.abs(n.vy)>0.1;
      if(n.vx>0)n.facing="right";
      if(n.vx<0)n.facing="left";

      if(n.moving){
        n.tick++;
        if(n.tick>=WALK_DELAY){
          n.frame=(n.frame+1)%16;
          n.tick=0;
        }
      }else n.frame=0;
    }
  });

  /* EVENTO EVA */
  if(eventPhase===1){
    eventTimer--;
    if(eventTimer<=0){
      eventPhase=2;
      eventTimer=360; // 6s

      const radius=200;
      npcs.forEach((n,i)=>{
        if(n.dead) return;
        const angle=(i/npcs.length)*Math.PI*2;
        n.x=pony.x+Math.cos(angle)*radius;
        n.y=pony.y+Math.sin(angle)*radius;
        n.vx=0;n.vy=0;
      });
    }
  }
  else if(eventPhase===2){
    eventTimer--;
    if(eventTimer<=0){
      eventPhase=0;
      pony.frozen=false;

      npcs.forEach(n=>{
        if(!n.dead){
          n.x=n.originalX;
          n.y=n.originalY;
        }
      });
    }
  }

  draw();
  requestAnimationFrame(update);
}

/* ===== DRAW ===== */
function draw(){
  ctx.setTransform(zoom,0,0,zoom,0,0);
  ctx.clearRect(0,0,canvas.width/zoom,canvas.height/zoom);

  ctx.fillStyle="#4caf50";
  ctx.fillRect(0-camera.x,0-camera.y,WORLD_W,WORLD_H);

  /* NPC */
  npcs.forEach(n=>{
    const nx=n.x-camera.x;
    const ny=n.y-camera.y;

    if(n.dead){
      ctx.save();
      ctx.translate(nx+SIZE/2,ny+SIZE/2);
      ctx.rotate(Math.PI/2);
      ctx.drawImage(idleFrames[0],-SIZE/2,-SIZE/2,SIZE,SIZE);
      ctx.restore();
      return;
    }

    let img=n.moving?walkFrames[n.frame]:idleFrames[0];

    ctx.save();
    if(n.facing==="left"){
      ctx.translate(nx+SIZE,ny);
      ctx.scale(-1,1);
      ctx.drawImage(img,0,0,SIZE,SIZE);
    }else ctx.drawImage(img,nx,ny,SIZE,SIZE);
    ctx.restore();
  });

  /* JUGADOR */
  const px=pony.x-camera.x;
  const py=pony.y-camera.y;
  let img=pony.moving?walkFrames[pony.frame]:idleFrames[0];
  ctx.save();
  if(pony.facing==="left"){
    ctx.translate(px+SIZE,py);
    ctx.scale(-1,1);
    ctx.drawImage(img,0,0,SIZE,SIZE);
  }else ctx.drawImage(img,px,py,SIZE,SIZE);
  ctx.restore();

  /* TEXTO ROJO */
  if(eventPhase===1){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle="red";
    ctx.font="40px Arial";
    ctx.textAlign="center";
    ctx.fillText("- ¬øPor qu√© lo hiciste Eva...? -",
      canvas.width/2,
      canvas.height/2
    );
  }

  ctx.setTransform(1,0,0,1,0,0);
}

/* ===== IM√ÅGENES ===== */
let imagesToLoad=0,imagesLoaded=0;
function onLoad(){
  imagesLoaded++;
  if(imagesLoaded===32){
    requestAnimationFrame(update);
  }
}

const walkFrames=[];
for(let i=0;i<=15;i++){
  const img=new Image();
  img.onload=onLoad;
  img.src=`sprites/caminar/caminar_${i}.png`;
  walkFrames.push(img);
}

const idleFrames=[];
for(let i=0;i<=3;i++){
  const img=new Image();
  img.onload=onLoad;
  img.src=`sprites/idle/idle_${i}.png`;
  idleFrames.push(img);
}

</script>

/* ===== JOYSTICK ===== */
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyActive=false,joyX=0,joyY=0;
let moveX=0,moveY=0;

canvas.addEventListener("touchstart",e=>{
  if(e.touches.length>1)return;
  const t=e.touches[0];
  joyActive=true;
  joystick.style.display="block";
  joystick.style.left=(t.clientX-60)+"px";
  joystick.style.top=(t.clientY-60)+"px";
  joyX=t.clientX; joyY=t.clientY;
});

canvas.addEventListener("touchmove",e=>{
  if(!joyActive||e.touches.length>1)return;
  const t=e.touches[0];
  let dx=t.clientX-joyX;
  let dy=t.clientY-joyY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const max=40;
  if(dist>max){
    dx=dx/dist*max;
    dy=dy/dist*max;
  }
  stick.style.left=(dx+30)+"px";
  stick.style.top=(dy+30)+"px";
  moveX=dx/max;
  moveY=dy/max;
});

canvas.addEventListener("touchend",()=>{
  joyActive=false;
  joystick.style.display="none";
  stick.style.left="30px";
  stick.style.top="30px";
  moveX=0; moveY=0;
});

/* ===== FUNCI√ìN HACHA (MISMO TAMA√ëO SIEMPRE) ===== */
function drawAxe(x,y,rotation=0){
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(rotation);

  ctx.fillStyle="#8b5a2b";
  ctx.fillRect(-3,0,6,30);

  ctx.fillStyle="#c62828";
  ctx.fillRect(-18,-18,36,18);

  ctx.fillStyle="#ff5252";
  ctx.fillRect(-10,-14,16,6);

  ctx.restore();
}

/* ===== UPDATE ===== */
function update(){

  pony.moving=false;

  if(moveX||moveY){
    pony.x+=moveX*SPEED;
    pony.y+=moveY*SPEED;
    pony.moving=true;
    if(moveX>0)pony.facing="right";
    if(moveX<0)pony.facing="left";
  }

  pony.x=Math.max(0,Math.min(WORLD_W-SIZE,pony.x));
  pony.y=Math.max(0,Math.min(WORLD_H-SIZE,pony.y));

  camera.x=pony.x-(canvas.width/(2*zoom))+SIZE/2;
  camera.y=pony.y-(canvas.height/(2*zoom))+SIZE/2;

  if(pony.moving){
    pony.tick++;
    if(pony.tick>=WALK_DELAY){
      pony.frame=(pony.frame+1)%walkFrames.length;
      pony.tick=0;
    }
  }else pony.frame=0;

  /* NPC */
  npcs.forEach(n=>{
    n.timer--;
    if(n.timer<=0){
      if(Math.random()<0.4){
        n.vx=0;n.vy=0;
      }else{
        const a=Math.random()*Math.PI*2;
        n.vx=Math.cos(a)*1.5;
        n.vy=Math.sin(a)*1.5;
      }
      n.timer=60+Math.random()*120;
    }
    n.x+=n.vx; n.y+=n.vy;
    n.moving=Math.abs(n.vx)>0.1||Math.abs(n.vy)>0.1;
    if(n.vx>0)n.facing="right";
    if(n.vx<0)n.facing="left";
    if(n.moving){
      n.tick++;
      if(n.tick>=WALK_DELAY){
        n.frame=(n.frame+1)%walkFrames.length;
        n.tick=0;
      }
    }else n.frame=0;
  });

  /* PROXIMIDAD */
  actionType=null;

  if(!inventory.axe && !axeWorld.picked){
    if(Math.hypot(pony.x-axeWorld.x,pony.y-axeWorld.y)<120){
      actionType="pick";
    }
  }

  if(inventory.axe){
    trees.forEach(t=>{
      if(Math.hypot(pony.x-t.x,pony.y-t.y)<140){
        actionType="chop";
        t.target=true;
      }else t.target=false;
    });
  }

  actionBtn.style.display=actionType?"block":"none";
  actionBtn.innerText=actionType==="pick"?"Recoger":"Golpear";

  draw();
  requestAnimationFrame(update);
}

/* ===== DRAW ===== */
function draw(){
  ctx.setTransform(zoom,0,0,zoom,0,0);
  ctx.clearRect(0,0,canvas.width/zoom,canvas.height/zoom);

  ctx.fillStyle="#4caf50";
  ctx.fillRect(0-camera.x,0-camera.y,WORLD_W,WORLD_H);

  /* √ÅRBOLES */
  trees.forEach(t=>{
    const tx=t.x-camera.x;
    const ty=t.y-camera.y;
    ctx.fillStyle="#5a3a1a";
    ctx.fillRect(tx+20,ty+60,20,40);
    ctx.fillStyle=t.target?"#2e7d32":"#388e3c";
    ctx.beginPath();
    ctx.arc(tx+30,ty+50,40,0,Math.PI*2);
    ctx.fill();
  });

  /* HACHA SUELO */
  if(!axeWorld.picked){
    const ax=axeWorld.x-camera.x;
    const ay=axeWorld.y-camera.y;
    drawAxe(ax,ay+20,0);
  }

  /* NPC */
  npcs.forEach(n=>{
    const nx=n.x-camera.x;
    const ny=n.y-camera.y;
    let img=n.moving?walkFrames[n.frame]:idleFrames[0];
    ctx.save();
    if(n.facing==="left"){
      ctx.translate(nx+SIZE,ny);
      ctx.scale(-1,1);
      ctx.drawImage(img,0,0,SIZE,SIZE);
    }else ctx.drawImage(img,nx,ny,SIZE,SIZE);
    ctx.restore();
  });

  /* JUGADOR */
  const px=pony.x-camera.x;
  const py=pony.y-camera.y;
  let img=pony.moving?walkFrames[pony.frame]:idleFrames[0];
  ctx.save();
  if(pony.facing==="left"){
    ctx.translate(px+SIZE,py);
    ctx.scale(-1,1);
    ctx.drawImage(img,0,0,SIZE,SIZE);
  }else ctx.drawImage(img,px,py,SIZE,SIZE);
  ctx.restore();

  /* ===== HACHA EN BOCA PERFECTA ===== */
if(inventory.axe){

    // Ajuste fino de posici√≥n
    const mouthX = pony.facing==="right" ? px+88 : px+40;
    const mouthY = py+54;

    ctx.save();

    if(pony.facing==="right"){
        drawAxe(mouthX, mouthY, 1.5708);
    }else{
        ctx.scale(-1,1);
        drawAxe(-mouthX, mouthY, 1.5708);
    }

    ctx.restore();
}

  ctx.setTransform(1,0,0,1,0,0);
}

</script>
</body>
</html>
