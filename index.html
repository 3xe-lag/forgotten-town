<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Forgotten Town</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
html, body{
  margin:0;
  padding:0;
  background:#222;
  overflow:hidden;
  touch-action:none;
}
canvas{ display:block; }

/* ===== JOYSTICK ===== */
#joystick{
  position:fixed;
  width:120px;
  height:120px;
  border-radius:50%;
  background:rgba(255,255,255,0.08);
  display:none;
  z-index:20;
}
#stick{
  position:absolute;
  width:60px;
  height:60px;
  border-radius:50%;
  background:rgba(255,255,255,0.3);
  left:30px;
  top:30px;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div id="joystick">
  <div id="stick"></div>
</div>

<script>

/* ===== CANVAS ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ===== CONFIG ===== */
const SIZE = 96;
const SPEED = 4;
const WALK_DELAY = 4;
const WORLD_W = 3000;
const WORLD_H = 3000;

/* ===== CÁMARA + ZOOM ===== */
let camera = {x:0,y:0};
let zoom = 1;
const MIN_ZOOM = 0.5;
const MAX_ZOOM = 2;

/* ===== JUGADOR ===== */
let pony = {
  x: WORLD_W/2,
  y: WORLD_H/2,
  frame:0,
  tick:0,
  moving:false,
  facing:"right"
};

/* ===== NPC FACTORY ===== */
function createNPC(x,y){
  return {
    x:x,
    y:y,
    vx:0,
    vy:0,
    timer:0,
    frame:0,
    tick:0,
    moving:false,
    facing:"right"
  };
}

let npcs = [
  createNPC(pony.x+200, pony.y-150),
  createNPC(pony.x-250, pony.y+100)
];

/* ===== ÁRBOLES FIJOS ===== */
let trees = [
  {x:800,y:600},
  {x:1200,y:900},
  {x:600,y:1300}
];

let wood = 0;
let gatherStart = 0;

/* ===== IMÁGENES ===== */
let imagesToLoad=0, imagesLoaded=0;
function onImageLoad(){
  imagesLoaded++;
  if(imagesLoaded===imagesToLoad){
    requestAnimationFrame(update);
  }
}

const walkFrames=[];
for(let i=0;i<=15;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/caminar/caminar_${i}.png`;
  walkFrames.push(img);
}

const idleFrames=[];
for(let i=0;i<=3;i++){
  imagesToLoad++;
  const img=new Image();
  img.onload=onImageLoad;
  img.src=`sprites/idle/idle_${i}.png`;
  idleFrames.push(img);
}

/* ===== JOYSTICK ===== */
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");

let joyActive=false;
let joyX=0;
let joyY=0;
let moveX=0;
let moveY=0;

canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  joyActive=true;
  joystick.style.display="block";
  joystick.style.left=(t.clientX-60)+"px";
  joystick.style.top=(t.clientY-60)+"px";
  joyX=t.clientX;
  joyY=t.clientY;
});

canvas.addEventListener("touchmove",e=>{
  if(!joyActive)return;
  const t=e.touches[0];
  let dx=t.clientX-joyX;
  let dy=t.clientY-joyY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const max=40;
  if(dist>max){
    dx=dx/dist*max;
    dy=dy/dist*max;
  }
  stick.style.left=(dx+30)+"px";
  stick.style.top=(dy+30)+"px";
  moveX=dx/max;
  moveY=dy/max;
});

canvas.addEventListener("touchend",()=>{
  joyActive=false;
  joystick.style.display="none";
  stick.style.left="30px";
  stick.style.top="30px";
  moveX=0;
  moveY=0;
});

/* ===== ZOOM ===== */
canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  zoom+=e.deltaY*-0.001;
  zoom=Math.max(MIN_ZOOM,Math.min(MAX_ZOOM,zoom));
});

let lastDist=null;
canvas.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(lastDist){
      zoom+=(dist-lastDist)*0.002;
      zoom=Math.max(MIN_ZOOM,Math.min(MAX_ZOOM,zoom));
    }
    lastDist=dist;
  }
});
canvas.addEventListener("touchend",()=>lastDist=null);

/* ===== UPDATE ===== */
function update(){

  /* ===== MOVIMIENTO JUGADOR ===== */
  pony.moving=false;

  if(moveX||moveY){
    pony.x+=moveX*SPEED;
    pony.y+=moveY*SPEED;
    pony.moving=true;

    if(moveX>0)pony.facing="right";
    if(moveX<0)pony.facing="left";
  }

  pony.x=Math.max(0,Math.min(WORLD_W-SIZE,pony.x));
  pony.y=Math.max(0,Math.min(WORLD_H-SIZE,pony.y));

  camera.x=pony.x-(canvas.width/(2*zoom))+SIZE/2;
  camera.y=pony.y-(canvas.height/(2*zoom))+SIZE/2;

  if(pony.moving){
    pony.tick++;
    if(pony.tick>=WALK_DELAY){
      pony.frame=(pony.frame+1)%walkFrames.length;
      pony.tick=0;
    }
  }else{
    pony.frame=0;
  }

  /* ===== NPC MOVIMIENTO SUAVE ===== */
  npcs.forEach(npc=>{
    npc.timer--;
    if(npc.timer<=0){
      if(Math.random()<0.4){
        npc.vx=0;
        npc.vy=0;
      }else{
        const angle=Math.random()*Math.PI*2;
        npc.vx=Math.cos(angle)*1.5;
        npc.vy=Math.sin(angle)*1.5;
      }
      npc.timer=80+Math.random()*120;
    }

    npc.x+=npc.vx;
    npc.y+=npc.vy;

    npc.x=Math.max(0,Math.min(WORLD_W-SIZE,npc.x));
    npc.y=Math.max(0,Math.min(WORLD_H-SIZE,npc.y));

    npc.moving=Math.abs(npc.vx)>0.1||Math.abs(npc.vy)>0.1;

    if(npc.vx>0)npc.facing="right";
    if(npc.vx<0)npc.facing="left";

    if(npc.moving){
      npc.tick++;
      if(npc.tick>=WALK_DELAY){
        npc.frame=(npc.frame+1)%walkFrames.length;
        npc.tick=0;
      }
    }else{
      npc.frame=0;
    }
  });

  /* ===== RECOLECCIÓN ===== */
  let gathering=false;

  trees=trees.filter(tree=>{
    const dx=pony.x-tree.x;
    const dy=pony.y-tree.y;
    const dist=Math.sqrt(dx*dx+dy*dy);

    if(dist<120){
      gathering=true;
      if(!gatherStart)gatherStart=Date.now();
      if(Date.now()-gatherStart>1000){
        wood++;
        gatherStart=0;
        return false;
      }
    }
    return true;
  });

  if(!gathering)gatherStart=0;

  draw();
  requestAnimationFrame(update);
}

/* ===== DRAW ===== */
function draw(){

  ctx.setTransform(zoom,0,0,zoom,0,0);
  ctx.clearRect(0,0,canvas.width/zoom,canvas.height/zoom);

  /* ===== MAPA ===== */
  ctx.fillStyle="#3fa34d";
  ctx.fillRect(-camera.x,-camera.y,WORLD_W,WORLD_H);

  /* ===== ÁRBOLES ===== */
  trees.forEach(tree=>{
    const tx=tree.x-camera.x;
    const ty=tree.y-camera.y;

    ctx.fillStyle="#6b3f1d";
    ctx.fillRect(tx+30,ty+60,40,40);

    ctx.fillStyle="#2e7d32";
    ctx.beginPath();
    ctx.arc(tx+50,ty+50,50,0,Math.PI*2);
    ctx.fill();
  });

  /* ===== NPCs ===== */
  npcs.forEach(npc=>{
    const nx=npc.x-camera.x;
    const ny=npc.y-camera.y;
    const img=npc.moving?walkFrames[npc.frame]:idleFrames[0];

    ctx.save();
    if(npc.facing==="left"){
      ctx.translate(nx+SIZE,ny);
      ctx.scale(-1,1);
      ctx.drawImage(img,0,0,SIZE,SIZE);
    }else{
      ctx.drawImage(img,nx,ny,SIZE,SIZE);
    }
    ctx.restore();
  });

  /* ===== JUGADOR ===== */
  const px=pony.x-camera.x;
  const py=pony.y-camera.y;
  const img=pony.moving?walkFrames[pony.frame]:idleFrames[0];

  ctx.save();
  if(pony.facing==="left"){
    ctx.translate(px+SIZE,py);
    ctx.scale(-1,1);
    ctx.drawImage(img,0,0,SIZE,SIZE);
  }else{
    ctx.drawImage(img,px,py,SIZE,SIZE);
  }
  ctx.restore();

  ctx.setTransform(1,0,0,1,0,0);

  /* ===== UI ===== */
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.fillText("Madera: "+wood,20,30);
}

</script>
</body>
</html>
